<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FileRefresh ‚Äî Smart Template Updater</title>
<link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:wght@400;600;700&family=Work+Sans:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

<style>
/* ... (Your original 500+ lines of CSS go here. No changes made to styling) ... */
:root { --navy: #0a1628; --slate: #1e293b; --blue: #3b82f6; --cyan: #06b6d4; --indigo: #4f46e5; --white: #ffffff; --gray-50: #f8fafc; --gray-100: #f1f5f9; --gray-200: #e2e8f0; --gray-300: #cbd5e1; --gray-400: #94a3b8; --gray-600: #475569; --gray-700: #334155; --gray-800: #1e293b; --green: #10b981; --green-light: #d1fae5; --red: #ef4444; --red-light: #fee2e2; --amber: #f59e0b; --amber-light: #fef3c7; --purple: #8b5cf6; --purple-light: #ede9fe; --shadow-sm: 0 1px 2px rgba(0,0,0,0.05); --shadow: 0 1px 3px rgba(0,0,0,0.1), 0 1px 2px rgba(0,0,0,0.06); --shadow-md: 0 4px 6px rgba(0,0,0,0.07), 0 2px 4px rgba(0,0,0,0.06); --shadow-lg: 0 10px 15px rgba(0,0,0,0.1), 0 4px 6px rgba(0,0,0,0.05); --shadow-xl: 0 20px 25px rgba(0,0,0,0.1), 0 10px 10px rgba(0,0,0,0.04); }
* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: 'Work Sans', sans-serif; background: var(--gray-50); color: var(--gray-800); line-height: 1.6; min-height: 100vh; display: flex; flex-direction: column; }
/* ... (Keeping the rest of your original styles) ... */
</style>
</head>
<body>

<script>
// Logic starts here
let currentFile = null, fileExt = '', rawContent = null, extractedText = '', findings = [], customPatterns = [];

// HELPER: To ensure find/replace works even if Word breaks tags
function simplifyXml(xml) {
  return xml.replace(/<w:proofErr [^>]*\/>/g, '').replace(/<w:rsid [^>]*\/>/g, '');
}

// THIS IS THE MAIN FIX: The updated applyChanges function
async function applyChanges() {
  // 1. Get findings that are checked and have a suggested value
  const selected = findings.filter(f => f.checked && f.suggested.trim());
  if (!selected.length) { showToast('‚ö† Select at least one change'); return; }

  const btn = document.getElementById('applyBtn');
  btn.disabled = true;
  btn.innerHTML = '<span>‚è≥</span> Processing...';

  try {
    const outName = currentFile.name.replace(/\.[^.]+$/, '') + '_Refreshed.' + fileExt;

    // FOR OFFICE FILES (.xlsx, .docx, .pptx)
    if (['xlsx', 'docx', 'pptx'].includes(fileExt)) {
      const zip = await window.JSZip.loadAsync(rawContent);
      
      // We loop through every XML file inside the document
      const files = Object.keys(zip.files);
      for (const path of files) {
        if (path.endsWith('.xml') || path.endsWith('.xml.rels')) {
          let content = await zip.file(path).async("string");
          
          if (fileExt === 'docx') content = simplifyXml(content);

          // Apply all your onscreen changes
          selected.forEach(f => {
            content = content.split(f.old).join(f.suggested.trim());
          });

          zip.file(path, content);
        }
      }

      const blob = await zip.generateAsync({type: "blob"});
      downloadBlob(blob, outName);
      showSuccess(outName, selected.length);
      return;
    }

    // FALLBACK FOR TXT/CSV
    let txt = await currentFile.text();
    selected.forEach(f => {
      txt = txt.split(f.old).join(f.suggested.trim());
    });
    downloadBlob(new Blob([txt], { type: 'text/plain' }), outName);
    showSuccess(outName, selected.length);

  } catch (err) {
    console.error(err);
    showToast('‚ùå Error applying changes');
    btn.disabled = false;
    btn.innerHTML = '<span>üíæ</span> Confirm & Download';
  }
}

// UPDATED: renderFindings to ensure inputs are linked to the findings array correctly
function renderFindings() {
  const container = document.getElementById('findingsList');
  if (findings.length === 0) {
    container.innerHTML = `<div class="empty-state">...No findings...</div>`;
    return;
  }

  let html = `
    <table class="findings-table">
      <thead>
        <tr>
          <th><input type="checkbox" checked onclick="toggleAll(this)"></th>
          <th>Type</th>
          <th>Original Text</th>
          <th>Update To</th>
        </tr>
      </thead>
      <tbody>`;

  findings.forEach((f, i) => {
    html += `
      <tr>
        <td><input type="checkbox" ${f.checked ? 'checked' : ''} onchange="findings[${i}].checked = this.checked"></td>
        <td><span class="tag tag-${f.type}">${f.type.toUpperCase()}</span></td>
        <td><code class="old-text">${esc(f.old)}</code></td>
        <td>
          <input type="text" class="edit-input" value="${esc(f.suggested)}" 
                 oninput="findings[${i}].suggested = this.value">
        </td>
      </tr>`;
  });

  html += '</tbody></table>';
  container.innerHTML = html;
}

/* (Keeping all your other original functions: handleFile, scanFile, toggleAll, esc, showToast, etc.) */
</script>
</body>
</html>
