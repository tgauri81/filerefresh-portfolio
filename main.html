<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FileRefresh ‚Äî Smart Template Updater</title>
<link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:wght@400;600;700&family=Work+Sans:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

<style>
/* Simplified core styles for the tool */
:root { --navy: #0a1628; --blue: #3b82f6; --gray-50: #f8fafc; --gray-200: #e2e8f0; --gray-800: #1e293b; }
body { font-family: 'Work Sans', sans-serif; background: var(--gray-50); color: var(--gray-800); padding: 20px; }
.card { background: white; border-radius: 16px; padding: 30px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); max-width: 1100px; margin: 40px auto; }
#dropZone { border: 2px dashed #cbd5e1; padding: 60px; text-align: center; border-radius: 12px; cursor: pointer; transition: 0.3s; }
#dropZone:hover { border-color: var(--blue); background: #f0f9ff; }
.preview-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0; border: 1px solid var(--gray-200); border-radius: 8px; height: 350px; overflow: hidden; }
.preview-pane { display: flex; flex-direction: column; background: #fff; }
.preview-header { background: #f1f5f9; padding: 8px 15px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; border-bottom: 1px solid var(--gray-200); }
.preview-content { padding: 15px; overflow-y: auto; font-family: 'JetBrains Mono', monospace; font-size: 0.85rem; white-space: pre-wrap; flex-grow: 1; }
.diff-old { background: #fee2e2; color: #991b1b; text-decoration: line-through; }
.diff-new { background: #d1fae5; color: #065f46; font-weight: 600; }
.btn { padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; border: none; }
.btn-primary { background: var(--blue); color: white; }
</style>
</head>
<body>

<div class="card">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 20px;">
        <h2>FileRefresh <span style="font-weight:400; color:var(--blue)">v5.0</span></h2>
        <a href="portfolio.html" style="text-decoration:none; color:#64748b; font-size:0.9rem;">‚Üê Back to Portfolio</a>
    </div>

    <div id="uploadStep">
        <div id="dropZone" onclick="document.getElementById('fileInput').click()">
            <div style="font-size: 40px; margin-bottom: 10px;">üìÑ</div>
            <h3>Upload Template</h3>
            <p>Drag & drop your .xlsx, .docx, or .txt file here</p>
            <input type="file" id="fileInput" hidden onchange="handleFile(this.files[0])">
        </div>
    </div>

    <div id="resultsStep" style="display:none;">
        <div class="preview-container">
            <div class="preview-pane">
                <div class="preview-header">Original (Stale)</div>
                <div id="originalPane" class="preview-content"></div>
            </div>
            <div class="preview-pane">
                <div class="preview-header">Refreshed (Updated)</div>
                <div id="refreshedPane" class="preview-content"></div>
            </div>
        </div>
        <div id="findingsTableContainer"></div>
        <div style="margin-top: 30px; display: flex; justify-content: flex-end; gap: 15px;">
            <button class="btn" style="background:#e2e8f0" onclick="location.reload()">Reset</button>
            <button id="applyBtn" class="btn btn-primary" onclick="applyChanges()">Apply & Download</button>
        </div>
    </div>
</div>

<script>
let currentFile = null, fileExt = '', rawContent = null, extractedText = '', findings = [];

function simplifyXml(xml) { return xml.replace(/<w:proofErr [^>]*\/>/g, '').replace(/<w:rsid [^>]*\/>/g, ''); }

async function handleFile(file) {
    if (!file) return;
    currentFile = file;
    fileExt = file.name.split('.').pop().toLowerCase();
    rawContent = await file.arrayBuffer();
    
    if (fileExt === 'docx') {
        const res = await mammoth.extractRawText({arrayBuffer: rawContent});
        extractedText = res.value;
    } else if (fileExt === 'xlsx') {
        const wb = XLSX.read(rawContent, {type: 'array'});
        extractedText = wb.SheetNames.map(n => XLSX.utils.sheet_to_txt(wb.Sheets[n])).join(' ');
    } else {
        extractedText = await file.text();
    }

    detectChanges();
    document.getElementById('uploadStep').style.display = 'none';
    document.getElementById('resultsStep').style.display = 'block';
}

function detectChanges() {
    findings = [];
    const lastYear = new Date().getFullYear() - 1;
    const regex = new RegExp(lastYear.toString(), 'g');
    let m;
    while ((m = regex.exec(extractedText)) !== null) {
        if (!findings.find(f => f.old === m[0])) {
            findings.push({ type: 'year', old: m[0], suggested: (lastYear + 1).toString(), checked: true });
        }
    }
    renderUI();
}

function renderUI() {
    updateDiff();
    const container = document.getElementById('findingsTableContainer');
    let html = `<table style="width:100%; border-collapse:collapse; margin-top:20px;">
        <tr style="text-align:left; border-bottom:2px solid #f1f5f9"><th style="padding:10px">Type</th><th>Original</th><th>Update To</th></tr>`;
    findings.forEach((f, i) => {
        html += `<tr style="border-bottom:1px solid #f1f5f9">
            <td style="padding:10px"><span style="background:#e0f2fe; padding:2px 8px; border-radius:4px; font-size:0.7rem">${f.type}</span></td>
            <td><code class="diff-old">${f.old}</code></td>
            <td><input type="text" value="${f.suggested}" oninput="findings[${i}].suggested=this.value; updateDiff()" style="padding:5px; border:1px solid #ddd; border-radius:4px"></td>
        </tr>`;
    });
    container.innerHTML = html + `</table>`;
}

function updateDiff() {
    let oldTxt = extractedText.substring(0, 2000);
    let newTxt = oldTxt;
    findings.forEach(f => {
        const r = new RegExp(f.old, 'g');
        oldTxt = oldTxt.replace(r, `<span class="diff-old">${f.old}</span>`);
        newTxt = newTxt.replace(r, `<span class="diff-new">${f.suggested}</span>`);
    });
    document.getElementById('originalPane').innerHTML = oldTxt;
    document.getElementById('refreshedPane').innerHTML = newTxt;
}

async function applyChanges() {
    const zip = await window.JSZip.loadAsync(rawContent);
    const files = Object.keys(zip.files);
    for (const path of files) {
        if (path.endsWith('.xml') || path.endsWith('.xml.rels')) {
            let content = await zip.file(path).async("string");
            if (fileExt === 'docx') content = simplifyXml(content);
            findings.forEach(f => { content = content.split(f.old).join(f.suggested); });
            zip.file(path, content);
        }
    }
    const blob = await zip.generateAsync({type: "blob"});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `Refreshed_${currentFile.name}`;
    a.click();
}
</script>
</body>
</html>
